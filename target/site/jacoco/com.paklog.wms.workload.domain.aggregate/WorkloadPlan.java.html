<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WorkloadPlan.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">workload-planning-service</a> &gt; <a href="index.source.html" class="el_package">com.paklog.wms.workload.domain.aggregate</a> &gt; <span class="el_source">WorkloadPlan.java</span></div><h1>WorkloadPlan.java</h1><pre class="source lang-java linenums">package com.paklog.wms.workload.domain.aggregate;

import com.paklog.wms.workload.domain.entity.WorkerCapacity;
import com.paklog.wms.workload.domain.valueobject.ShiftType;
import com.paklog.wms.workload.domain.valueobject.WorkloadCategory;
import org.springframework.data.annotation.Id;
import org.springframework.data.mongodb.core.index.Indexed;
import org.springframework.data.mongodb.core.mapping.Document;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * WorkloadPlan - Aggregate root for workload and labor planning
 *
 * Combines demand forecasts with labor capacity to create optimal staffing plans
 */
@Document(collection = &quot;workload_plans&quot;)
public class WorkloadPlan {

    @Id
    private String planId;

    @Indexed
    private String warehouseId;

    @Indexed
    private LocalDate planDate;

    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;

    // Planned workload by category
    private Map&lt;WorkloadCategory, Integer&gt; plannedVolumes;

    // Shift assignments (shift -&gt; list of assigned workers)
    private Map&lt;ShiftType, List&lt;ShiftAssignment&gt;&gt; shiftAssignments;

    // Capacity metrics
    private Integer totalRequiredLaborHours;
    private Integer totalAvailableLaborHours;
    private Double utilizationPercentage;
    private Double estimatedLaborCost;

    // Status
    private PlanStatus status;
    private String notes;

<span class="fc" id="L53">    protected WorkloadPlan() {</span>
<span class="fc" id="L54">        this.plannedVolumes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L55">        this.shiftAssignments = new HashMap&lt;&gt;();</span>
<span class="fc" id="L56">    }</span>

    /**
     * Create a new workload plan
     */
    public static WorkloadPlan create(String planId, String warehouseId, LocalDate planDate) {
<span class="fc" id="L62">        WorkloadPlan plan = new WorkloadPlan();</span>
<span class="fc" id="L63">        plan.planId = planId;</span>
<span class="fc" id="L64">        plan.warehouseId = warehouseId;</span>
<span class="fc" id="L65">        plan.planDate = planDate;</span>
<span class="fc" id="L66">        plan.createdAt = LocalDateTime.now();</span>
<span class="fc" id="L67">        plan.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L68">        plan.plannedVolumes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L69">        plan.shiftAssignments = new HashMap&lt;&gt;();</span>
<span class="fc" id="L70">        plan.status = PlanStatus.DRAFT;</span>
<span class="fc" id="L71">        plan.totalRequiredLaborHours = 0;</span>
<span class="fc" id="L72">        plan.totalAvailableLaborHours = 0;</span>
<span class="fc" id="L73">        plan.utilizationPercentage = 0.0;</span>
<span class="fc" id="L74">        plan.estimatedLaborCost = 0.0;</span>

<span class="fc" id="L76">        return plan;</span>
    }

    /**
     * Set planned volume for a category
     */
    public void setPlannedVolume(WorkloadCategory category, int volume) {
<span class="fc" id="L83">        plannedVolumes.put(category, volume);</span>
<span class="fc" id="L84">        recalculateMetrics();</span>
<span class="fc" id="L85">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L86">    }</span>

    /**
     * Assign worker to shift
     */
    public void assignWorkerToShift(ShiftType shift, String workerId, String workerName,
                                    WorkloadCategory primaryCategory, int plannedHours) {
<span class="fc" id="L93">        ShiftAssignment assignment = new ShiftAssignment(</span>
            workerId, workerName, primaryCategory, plannedHours
        );

<span class="fc" id="L97">        shiftAssignments.computeIfAbsent(shift, k -&gt; new ArrayList&lt;&gt;()).add(assignment);</span>
<span class="fc" id="L98">        recalculateMetrics();</span>
<span class="fc" id="L99">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L100">    }</span>

    /**
     * Remove worker from shift
     */
    public void removeWorkerFromShift(ShiftType shift, String workerId) {
<span class="fc" id="L106">        List&lt;ShiftAssignment&gt; assignments = shiftAssignments.get(shift);</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (assignments != null) {</span>
<span class="fc" id="L108">            assignments.removeIf(a -&gt; a.workerId().equals(workerId));</span>
<span class="fc" id="L109">            recalculateMetrics();</span>
<span class="fc" id="L110">            this.updatedAt = LocalDateTime.now();</span>
        }
<span class="fc" id="L112">    }</span>

    /**
     * Approve the plan
     */
    public void approve() {
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (status == PlanStatus.DRAFT) {</span>
<span class="fc" id="L119">            this.status = PlanStatus.APPROVED;</span>
<span class="fc" id="L120">            this.updatedAt = LocalDateTime.now();</span>
        } else {
<span class="fc" id="L122">            throw new IllegalStateException(&quot;Only draft plans can be approved&quot;);</span>
        }
<span class="fc" id="L124">    }</span>

    /**
     * Publish the plan
     */
    public void publish() {
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (status == PlanStatus.APPROVED) {</span>
<span class="fc" id="L131">            this.status = PlanStatus.PUBLISHED;</span>
<span class="fc" id="L132">            this.updatedAt = LocalDateTime.now();</span>
        } else {
<span class="fc" id="L134">            throw new IllegalStateException(&quot;Only approved plans can be published&quot;);</span>
        }
<span class="fc" id="L136">    }</span>

    /**
     * Cancel the plan
     */
    public void cancel(String reason) {
<span class="fc" id="L142">        this.status = PlanStatus.CANCELLED;</span>
<span class="fc" id="L143">        this.notes = reason;</span>
<span class="fc" id="L144">        this.updatedAt = LocalDateTime.now();</span>
<span class="fc" id="L145">    }</span>

    /**
     * Get workers assigned to a shift
     */
    public List&lt;ShiftAssignment&gt; getShiftAssignments(ShiftType shift) {
<span class="fc" id="L151">        return new ArrayList&lt;&gt;(shiftAssignments.getOrDefault(shift, new ArrayList&lt;&gt;()));</span>
    }

    /**
     * Get total workers assigned
     */
    public int getTotalWorkersAssigned() {
<span class="fc" id="L158">        return shiftAssignments.values().stream()</span>
<span class="fc" id="L159">            .mapToInt(List::size)</span>
<span class="fc" id="L160">            .sum();</span>
    }

    /**
     * Get total hours assigned for a shift
     */
    public int getTotalHoursForShift(ShiftType shift) {
<span class="fc" id="L167">        return shiftAssignments.getOrDefault(shift, new ArrayList&lt;&gt;()).stream()</span>
<span class="fc" id="L168">            .mapToInt(ShiftAssignment::plannedHours)</span>
<span class="fc" id="L169">            .sum();</span>
    }

    /**
     * Calculate required labor hours for all categories
     */
    public int calculateRequiredLaborHours() {
<span class="fc" id="L176">        return plannedVolumes.entrySet().stream()</span>
<span class="fc" id="L177">            .mapToInt(entry -&gt; {</span>
<span class="fc" id="L178">                WorkloadCategory category = entry.getKey();</span>
<span class="fc" id="L179">                int volume = entry.getValue();</span>
<span class="fc" id="L180">                return (int) Math.ceil(category.calculateLaborHours(volume));</span>
            })
<span class="fc" id="L182">            .sum();</span>
    }

    /**
     * Check if plan is understaffed
     */
    public boolean isUnderstaffed() {
<span class="pc bpc" id="L189" title="2 of 4 branches missed.">        return utilizationPercentage != null &amp;&amp; utilizationPercentage &lt; 85.0;</span>
    }

    /**
     * Check if plan is overstaffed
     */
    public boolean isOverstaffed() {
<span class="pc bpc" id="L196" title="2 of 4 branches missed.">        return utilizationPercentage != null &amp;&amp; utilizationPercentage &gt; 110.0;</span>
    }

    /**
     * Check if plan is balanced
     */
    public boolean isBalanced() {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        return utilizationPercentage != null &amp;&amp;</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">               utilizationPercentage &gt;= 85.0 &amp;&amp;</span>
<span class="pc bnc" id="L205" title="All 2 branches missed.">               utilizationPercentage &lt;= 110.0;</span>
    }

    /**
     * Recalculate all metrics
     */
    private void recalculateMetrics() {
        // Calculate required hours
<span class="fc" id="L213">        this.totalRequiredLaborHours = calculateRequiredLaborHours();</span>

        // Calculate available hours
<span class="fc" id="L216">        this.totalAvailableLaborHours = shiftAssignments.values().stream()</span>
<span class="fc" id="L217">            .flatMap(List::stream)</span>
<span class="fc" id="L218">            .mapToInt(ShiftAssignment::plannedHours)</span>
<span class="fc" id="L219">            .sum();</span>

        // Calculate utilization
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (totalAvailableLaborHours &gt; 0) {</span>
<span class="fc" id="L223">            this.utilizationPercentage = (totalRequiredLaborHours * 100.0) / totalAvailableLaborHours;</span>
        } else {
<span class="fc" id="L225">            this.utilizationPercentage = 0.0;</span>
        }

        // Calculate estimated cost (simplified)
<span class="fc" id="L229">        this.estimatedLaborCost = totalAvailableLaborHours * 25.0; // Avg $25/hour</span>
<span class="fc" id="L230">    }</span>

    // Getters
    public String getPlanId() {
<span class="fc" id="L234">        return planId;</span>
    }

    public String getWarehouseId() {
<span class="fc" id="L238">        return warehouseId;</span>
    }

    public LocalDate getPlanDate() {
<span class="fc" id="L242">        return planDate;</span>
    }

    public LocalDateTime getCreatedAt() {
<span class="fc" id="L246">        return createdAt;</span>
    }

    public LocalDateTime getUpdatedAt() {
<span class="fc" id="L250">        return updatedAt;</span>
    }

    public Map&lt;WorkloadCategory, Integer&gt; getPlannedVolumes() {
<span class="fc" id="L254">        return new HashMap&lt;&gt;(plannedVolumes);</span>
    }

    public Map&lt;ShiftType, List&lt;ShiftAssignment&gt;&gt; getShiftAssignments() {
<span class="fc" id="L258">        return new HashMap&lt;&gt;(shiftAssignments);</span>
    }

    public Integer getTotalRequiredLaborHours() {
<span class="fc" id="L262">        return totalRequiredLaborHours;</span>
    }

    public Integer getTotalAvailableLaborHours() {
<span class="fc" id="L266">        return totalAvailableLaborHours;</span>
    }

    public Double getUtilizationPercentage() {
<span class="fc" id="L270">        return utilizationPercentage;</span>
    }

    public Double getEstimatedLaborCost() {
<span class="nc" id="L274">        return estimatedLaborCost;</span>
    }

    public PlanStatus getStatus() {
<span class="fc" id="L278">        return status;</span>
    }

    public String getNotes() {
<span class="fc" id="L282">        return notes;</span>
    }

    /**
     * Shift assignment record
     */
<span class="fc" id="L288">    public record ShiftAssignment(</span>
        String workerId,
        String workerName,
        WorkloadCategory primaryCategory,
        int plannedHours
    ) {}

    /**
     * Plan status
     */
<span class="fc" id="L298">    public enum PlanStatus {</span>
<span class="fc" id="L299">        DRAFT,</span>
<span class="fc" id="L300">        APPROVED,</span>
<span class="fc" id="L301">        PUBLISHED,</span>
<span class="fc" id="L302">        CANCELLED</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L307">        return String.format(&quot;WorkloadPlan[id=%s, date=%s, status=%s, workers=%d, util=%s%%]&quot;,</span>
<span class="nc" id="L308">            planId, planDate, status, getTotalWorkersAssigned(), utilizationPercentage);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>